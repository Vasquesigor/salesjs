!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var e;(e=(e=(e=(e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).jsforce||(e.jsforce={})).modules||(e.modules={})).api||(e.api={})).Bulk=t()}}((function(){return function t(e,n,o){function r(s,a){if(!n[s]){if(!e[s]){var u="function"==typeof require&&require;if(!a&&u)return u(s,!0);if(i)return i(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var h=n[s]={exports:{}};e[s][0].call(h.exports,(function(t){return r(e[s][1][t]||t)}),h,h.exports,t,e,n,o)}return n[s].exports}for(var i="function"==typeof require&&require,s=0;s<o.length;s++)r(o[s]);return r}({1:[function(t,e,n){(function(t){"use strict";var n=window.jsforce.require("inherits"),o=window.jsforce.require("readable-stream"),r=o.Duplex,i=window.jsforce.require("events"),s=window.jsforce.require("lodash/core"),a=window.jsforce.require("multistream"),u=window.jsforce.require("./core"),c=window.jsforce.require("./record-stream"),h=window.jsforce.require("./promise"),l=window.jsforce.require("./http-api"),p=function(t,e,n,o,r){this._bulk=t,this.type=e,this.operation=n,this.options=o||{},this.id=r,this.state=this.id?"Open":"Unknown",this._batches={}};n(p,i.EventEmitter),p.prototype.info=function(t){return this._jobInfo||(this._jobInfo=this.check()),this._jobInfo.thenCall(t)},p.prototype.open=function(t){var e=this,n=this._bulk;n._logger;if(!this._jobInfo){var o=this.operation.toLowerCase();"harddelete"===o&&(o="hardDelete");var r=['<?xml version="1.0" encoding="UTF-8"?>','<jobInfo  xmlns="http://www.force.com/2009/06/asyncapi/dataload">',"<operation>"+o+"</operation>","<object>"+this.type+"</object>",this.options.extIdField?"<externalIdFieldName>"+this.options.extIdField+"</externalIdFieldName>":"",this.options.concurrencyMode?"<concurrencyMode>"+this.options.concurrencyMode+"</concurrencyMode>":"",this.options.assignmentRuleId?"<assignmentRuleId>"+this.options.assignmentRuleId+"</assignmentRuleId>":"","<contentType>CSV</contentType>","</jobInfo>"].join("");this._jobInfo=n._request({method:"POST",path:"/job",body:r,headers:{"Content-Type":"application/xml; charset=utf-8"},responseType:"application/xml"}).then((function(t){return e.emit("open",t.jobInfo),e.id=t.jobInfo.id,e.state=t.jobInfo.state,t.jobInfo}),(function(t){throw e.emit("error",t),t}))}return this._jobInfo.thenCall(t)},p.prototype.createBatch=function(){var t=new f(this),e=this;return t.on("queue",(function(){e._batches[t.id]=t})),t},p.prototype.batch=function(t){var e=this._batches[t];return e||(e=new f(this,t),this._batches[t]=e),e},p.prototype.check=function(t){var e=this,n=this._bulk,o=n._logger;return this._jobInfo=this._waitAssign().then((function(){return n._request({method:"GET",path:"/job/"+e.id,responseType:"application/xml"})})).then((function(t){return o.debug(t.jobInfo),e.id=t.jobInfo.id,e.type=t.jobInfo.object,e.operation=t.jobInfo.operation,e.state=t.jobInfo.state,t.jobInfo})),this._jobInfo.thenCall(t)},p.prototype._waitAssign=function(t){return(this.id?h.resolve({id:this.id}):this.open()).thenCall(t)},p.prototype.list=function(t){var e=this,n=this._bulk,o=n._logger;return this._waitAssign().then((function(){return n._request({method:"GET",path:"/job/"+e.id+"/batch",responseType:"application/xml"})})).then((function(t){o.debug(t.batchInfoList.batchInfo);var e=t.batchInfoList;return e=s.isArray(e.batchInfo)?e.batchInfo:[e.batchInfo]})).thenCall(t)},p.prototype.close=function(){var t=this;return this._changeState("Closed").then((function(e){return t.id=null,t.emit("close",e),e}),(function(e){throw t.emit("error",e),e}))},p.prototype.abort=function(){var t=this;return this._changeState("Aborted").then((function(e){return t.id=null,t.emit("abort",e),e}),(function(e){throw t.emit("error",e),e}))},p.prototype._changeState=function(t,e){var n=this,o=this._bulk,r=o._logger;return this._jobInfo=this._waitAssign().then((function(){var e=['<?xml version="1.0" encoding="UTF-8"?>','<jobInfo xmlns="http://www.force.com/2009/06/asyncapi/dataload">',"<state>"+t+"</state>","</jobInfo>"].join("");return o._request({method:"POST",path:"/job/"+n.id,body:e,headers:{"Content-Type":"application/xml; charset=utf-8"},responseType:"application/xml"})})).then((function(t){return r.debug(t.jobInfo),n.state=t.jobInfo.state,t.jobInfo})),this._jobInfo.thenCall(e)};var f=function(t,e){f.super_.call(this,{objectMode:!0}),this.job=t,this.id=e,this._bulk=t._bulk,this._deferred=h.defer(),this._setupDataStreams()};n(f,o.Writable),f.prototype._setupDataStreams=function(){var t=this,e={nullValue:"#N/A"};this._uploadStream=new c.Serializable,this._uploadDataStream=this._uploadStream.stream("csv",e),this._downloadStream=new c.Parsable,this._downloadDataStream=this._downloadStream.stream("csv",e),this.on("finish",(function(){t._uploadStream.end()})),this._uploadDataStream.once("readable",(function(){t.job.open().then((function(){t._uploadDataStream.pipe(t._createRequestStream())}))}));var n=this._dataStream=new r;n._write=function(e,n,o){t._uploadDataStream.write(e,n,o)},n.on("finish",(function(){t._uploadDataStream.end()})),this._downloadDataStream.on("readable",(function(){n.read(0)})),this._downloadDataStream.on("end",(function(){n.push(null)})),n._read=function(e){for(var o;null!==(o=t._downloadDataStream.read());)n.push(o)}},f.prototype._createRequestStream=function(){var t=this,e=t._bulk,n=e._logger;return e._request({method:"POST",path:"/job/"+t.job.id+"/batch",headers:{"Content-Type":"text/csv"},responseType:"application/xml"},(function(e,o){e?t.emit("error",e):(n.debug(o.batchInfo),t.id=o.batchInfo.id,t.emit("queue",o.batchInfo))})).stream()},f.prototype._write=function(t,e,n){t=s.clone(t),"insert"===this.job.operation?delete t.Id:"delete"===this.job.operation&&(t={Id:t.Id}),delete t.type,delete t.attributes,this._uploadStream.write(t,e,n)},f.prototype.stream=function(){return this._dataStream},f.prototype.run=f.prototype.exec=f.prototype.execute=function(t,e){var n=this;if("function"==typeof t&&(e=t,t=null),this._result)throw new Error("Batch already executed.");var o,r=h.defer();(this._result=r.promise,this._result.then((function(t){n._deferred.resolve(t)}),(function(t){n._deferred.reject(t)})),this.once("response",(function(t){r.resolve(t)})),this.once("error",(function(t){r.reject(t)})),s.isObject(t)&&s.isFunction(t.pipe))?t.pipe(this._dataStream):s.isArray(t)?(s.forEach(t,(function(t){Object.keys(t).forEach((function(e){"boolean"==typeof t[e]&&(t[e]=String(t[e]))})),n.write(t)})),n.end()):s.isString(t)&&(o=t,this._dataStream.write(o,"utf8"),this._dataStream.end());return this.thenCall(e)},f.prototype.then=function(t,e,n){return this._deferred.promise.then(t,e,n)},f.prototype.thenCall=function(e){return s.isFunction(e)&&this.then((function(n){t.nextTick((function(){e(null,n)}))}),(function(n){t.nextTick((function(){e(n)}))})),this},f.prototype.check=function(t){var e=this._bulk,n=e._logger,o=this.job.id,r=this.id;if(!o||!r)throw new Error("Batch not started.");return e._request({method:"GET",path:"/job/"+o+"/batch/"+r,responseType:"application/xml"}).then((function(t){return n.debug(t.batchInfo),t.batchInfo})).thenCall(t)},f.prototype.poll=function(t,e){var n=this,o=this.job.id,r=this.id;if(!o||!r)throw new Error("Batch not started.");var i=(new Date).getTime(),s=function(){var a=(new Date).getTime();if(i+e<a){var u=new Error("Polling time out. Job Id = "+o+" , batch Id = "+r);return u.name="PollingTimeout",u.jobId=o,u.batchId=r,void n.emit("error",u)}n.check((function(e,o){e?n.emit("error",e):"Failed"===o.state?parseInt(o.numberRecordsProcessed,10)>0?n.retrieve():n.emit("error",new Error(o.stateMessage)):"Completed"===o.state?n.retrieve():(n.emit("progress",o),setTimeout(s,t))}))};setTimeout(s,t)},f.prototype.retrieve=function(t){var e=this,n=this._bulk,o=this.job.id,r=this.job,i=this.id;if(!o||!i)throw new Error("Batch not started.");return r.info().then((function(t){return n._request({method:"GET",path:"/job/"+o+"/batch/"+i+"/result"})})).then((function(t){var a;if("query"===r.operation){n._conn,t["result-list"].result;a=t["result-list"].result,a=s.map(s.isArray(a)?a:[a],(function(t){return{id:t,batchId:i,jobId:o}}))}else a=s.map(t,(function(t){return{id:t.Id||null,success:"true"===t.Success,errors:t.Error?[t.Error]:[]}}));return e.emit("response",a),a})).fail((function(t){throw e.emit("error",t),t})).thenCall(t)},f.prototype.result=function(t){var e=this.job.id,n=this.id;if(!e||!n)throw new Error("Batch not started.");var o=new c.Parsable,r=o.stream("csv");this._bulk._request({method:"GET",path:"/job/"+e+"/batch/"+n+"/result/"+t,responseType:"application/octet-stream"}).stream().pipe(r);return o};var d=function(){d.super_.apply(this,arguments)};n(d,l),d.prototype.beforeSend=function(t){t.headers=t.headers||{},t.headers["X-SFDC-SESSION"]=this._conn.accessToken},d.prototype.isSessionExpired=function(t){return 400===t.statusCode&&/<exceptionCode>InvalidSessionId<\/exceptionCode>/.test(t.body)},d.prototype.hasErrorInResponseBody=function(t){return!!t.error},d.prototype.parseError=function(t){return{errorCode:t.error.exceptionCode,message:t.error.exceptionMessage}};var b=function(t){this._conn=t,this._logger=t._logger};b.prototype.pollInterval=1e3,b.prototype.pollTimeout=1e4,b.prototype._request=function(t,e){var n=this._conn;t=s.clone(t);var o=[n.instanceUrl,"services/async",n.version].join("/");t.url=o+t.path;var r={responseType:t.responseType};return delete t.path,delete t.responseType,new d(this._conn,r).request(t).thenCall(e)},b.prototype.load=function(t,e,n,o,r){var i=this;if(!t||!e)throw new Error("Insufficient arguments. At least, 'type' and 'operation' are required.");s.isObject(n)&&n.constructor===Object||(r=o,o=n,n=null);var a=this.createJob(t,e,n);a.once("error",(function(t){u&&u.emit("error",t)}));var u=a.createBatch(),c=function(){u=null,a.close()};return u.on("response",c),u.on("error",(function(t){"PollingTimeout"!==t.name&&c()})),u.on("queue",(function(){u.poll(i.pollInterval,i.pollTimeout)})),u.execute(o,r)},b.prototype.query=function(t){var e=t.replace(/\([\s\S]+\)/g,"").match(/FROM\s+(\w+)/i);if(!e)throw new Error("No sobject type found in query, maybe caused by invalid SOQL.");var n=e[1],o=this,r=new c.Parsable,i=r.stream("csv");return this.load(n,"query",t).then((function(t){var e=t.map((function(t){return o.job(t.jobId).batch(t.batchId).result(t.id).stream()}));a(e).pipe(i)})).fail((function(t){r.emit("error",t)})),r},b.prototype.createJob=function(t,e,n){return new p(this,t,e,n)},b.prototype.job=function(t){return new p(this,null,null,null,t)},u.on("connection:new",(function(t){t.bulk=new b(t)})),e.exports=b}).call(this,t("_process"))},{_process:2}],2:[function(t,e,n){var o,r,i=e.exports={};function s(){throw new Error("setTimeout has not been defined")}function a(){throw new Error("clearTimeout has not been defined")}function u(t){if(o===setTimeout)return setTimeout(t,0);if((o===s||!o)&&setTimeout)return o=setTimeout,setTimeout(t,0);try{return o(t,0)}catch(e){try{return o.call(null,t,0)}catch(e){return o.call(this,t,0)}}}!function(){try{o="function"==typeof setTimeout?setTimeout:s}catch(t){o=s}try{r="function"==typeof clearTimeout?clearTimeout:a}catch(t){r=a}}();var c,h=[],l=!1,p=-1;function f(){l&&c&&(l=!1,c.length?h=c.concat(h):p=-1,h.length&&d())}function d(){if(!l){var t=u(f);l=!0;for(var e=h.length;e;){for(c=h,h=[];++p<e;)c&&c[p].run();p=-1,e=h.length}c=null,l=!1,function(t){if(r===clearTimeout)return clearTimeout(t);if((r===a||!r)&&clearTimeout)return r=clearTimeout,clearTimeout(t);try{return r(t)}catch(e){try{return r.call(null,t)}catch(e){return r.call(this,t)}}}(t)}}function b(t,e){this.fun=t,this.array=e}function m(){}i.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)e[n-1]=arguments[n];h.push(new b(t,e)),1!==h.length||l||u(d)},b.prototype.run=function(){this.fun.apply(null,this.array)},i.title="browser",i.browser=!0,i.env={},i.argv=[],i.version="",i.versions={},i.on=m,i.addListener=m,i.once=m,i.off=m,i.removeListener=m,i.removeAllListeners=m,i.emit=m,i.prependListener=m,i.prependOnceListener=m,i.listeners=function(t){return[]},i.binding=function(t){throw new Error("process.binding is not supported")},i.cwd=function(){return"/"},i.chdir=function(t){throw new Error("process.chdir is not supported")},i.umask=function(){return 0}},{}]},{},[1])(1)}));
//# sourceMappingURL=jsforce-api-bulk.min.js.map
